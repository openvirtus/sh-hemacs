#!/bin/sh -e
#L:
#l:  Copyright (c) 2020 OpenVirtus.com, http://openvirtus.com
#L:
#L:  Permission is hereby granted, free of charge, to any person obtaining
#L:  a copy of this software and associated documentation files (the
#L:  "Software"), to deal in the Software without restriction, including
#L:  without limitation the rights to use, copy, modify, merge, publish,
#L:  distribute, sublicense, and/or sell copies of the Software, and to
#L:  permit persons to whom the Software is furnished to do so, subject to
#L:  the following conditions:
#L:
#L:  The above copyright notice and this permission notice shall be
#L:  included in all copies or substantial portions of the Software.
#L:
#L:  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
#L:  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
#L:  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
#L:  NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
#L:  LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
#L:  OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
#L:  WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
#L:
#h: Usage: $0 ...
#h:
#h: This script helps configuring and managing the GNU/Emacs text editor.
#h:
#h: -v         : Print environment variables.
#h: -P PACKAGE : Install package.
#h: -S         : Install basic setup.
#h:              - Adds all directories in `~/.emacs.d/packages`.
#h:              - Adds ~/.emacs.d/themes to theme path.
#h:              - Loads all files in `~/.emacs.d/profile.d/*.el`.
#h: -F         : Install `flycheck`, `yasnippet`, `company`, `sr-sidebar` and `yafolding`.
#h:              - Put a link in ~/.yasnippet to your directory.
#h:
#h: ## Manage chunks in [~/.emacs.d/init.el] ##########################
#h:
#h: -A NAME      < CODE.el : Add code named `NAME` into `init.el`.
#h: -I NAME      < CODE.el : Insert code.
#h: -B NAME=TEXT < CODE.el : Add button to run standard input code.
#h: -D NAME                : Delete code named `NAME` from `init.el`.
#h: -L                     : List code added to `init.el`
. hutil
hemacs() {
    ## Parse command line.
    local OPTIND optopt= ops= in_name= in_text= packages= p=
    while getopts "vSP:A:I:B:D:LF" optopt;do # OPTARG
	local ops="${ops}${optopt}"
        case $optopt in
            P)  local packages="${packages} ${OPTARG}";;
            A)  local in_name="${OPTARG}";;
            I)  local in_name="${OPTARG}";;
            B)  local in_name="`hutil optopt "${OPTARG}"`" \
                      in_text="`hutil optarg "${OPTARG}"`";;
            D)  local in_name="$OPTARG";;
            \?) return 1;;
        esac
    done
    shift $(( $OPTIND - 1 ))
    ## Emacs package.
    if test -n "${packages}";then
        hemacs_install_package ${packages}
    fi
    ## Execute commands.
    case "${ops}" in *v*) hemacs_show_variables      ;; esac
    case "${ops}" in *S*) hemacs_install_essentials  ;; esac
    case "${ops}" in *F*) hemacs_install_normal      ;; esac
    case "${ops}" in
        *A*) hemacs_add_code "${in_name}";;
        *I*) hemacs_ins_code "${in_name}";;
        *B*) hemacs_add_code_button "${in_name}" "${in_text}";;
        *D*) hemacs_del_code "${in_name}";;
    esac
    case "${ops}" in *L*) hemacs_lst_code;; esac
}
hemacs_calc_variables() {
    if test -n "${HEMACS_USER_DIRECTORY}";then
	true
    elif test -n "${HOME}";then
        HEMACS_USER_DIRECTORY="${HOME}/.emacs.d"
    elif test -n "$APPDATA";then
        HEMACS_USER_DIRECTORY="${APPDATA}/.emacs.d"
    fi
    HEMACS_INIT_FILE="${HEMACS_INIT_FILE:-${HEMACS_USER_DIRECTORY}/init.el}"
    HEMACS_PACKAGE_DIRECTORY="${HEMACS_PACKAGE_DIRECTORY:-${HEMACS_USER_DIRECTORY}/packages}"
}
hemacs_show_variables() {
    echo "HEMACS_USER_DIRECTORY    = ${HEMACS_USER_DIRECTORY}"
    echo "HEMACS_INIT_FILE         = ${HEMACS_INIT_FILE}"
    echo "HEMACS_PACKAGE_DIRECTORY = ${HEMACS_PACKAGE_DIRECTORY}"
    echo "YASNIPPET                = ${YASNIPPET}"
}









## --- [INIT MANAGER] ------------------------------------------------------------------------------
hemacs_del_code() { hutil fdel "$HEMACS_INIT_FILE" "$1"; }
hemacs_add_code() { hutil fadd "$HEMACS_INIT_FILE" "$1"; }
hemacs_ins_code() {
    mkdir -p "$HEMACS_USER_DIRECTORY"
    touch "$HEMACS_INIT_FILE"
    hutil fdel "$HEMACS_INIT_FILE" "$1"
    cat > "$HEMACS_INIT_FILE".tmp <<EOF
;; -- $1 --
`cat`
;; -- $1 --
`cat "$HEMACS_INIT_FILE"`
EOF
    mv "$HEMACS_INIT_FILE".tmp "$HEMACS_INIT_FILE"
}
hemacs_add_code_button() {
    local name="${1}" text="${2:-$1}"
    hutil errif "Please specify a button name." test ! -n "${name}"
    ## Add custom menu.
    if test ! -n "`hemacs_lst_code | grep custom-menu-2`";then
        hemacs_add_code "custom-menu" <<EOF
(define-key-after
    global-map
    [menu-bar extra]
    (cons "Extra" (make-sparse-keymap "Extra"))
    'tools )
EOF
    fi
    ## Add button.
    hemacs_add_code "${name}-button" <<EOF
(define-key
   global-map
   [menu-bar extra ${name}-button]
   '("${text} (${name})" . ${name}-button))
(defun ${name}-button ()
   "${name}"
   (interactive)
   `cat`)
EOF
}
hemacs_lst_code() {
    if test -f "$HEMACS_INIT_FILE";then
        sed -n 's/.*-- \(.*\) --.*/\1/p' "$HEMACS_INIT_FILE" | uniq
    fi
}






## --- [PACKAGE SYSTEM] ------------------------------------------------------------------------------
hemacs_install_package() {
    local refresh_file="/tmp/hemacs-refresh-`date '+%m%d'`.el"
    local package_file="/tmp/hemacs.tmp.el"
    if test ! -f "$refresh_file";then
        hemacs_print_package_code          > "$refresh_file"
        echo "(package-refresh-contents)" >> "$refresh_file"
        emacs --batch -l "$refresh_file"
    fi
    hemacs_print_package_code > "$package_file"
    for n in "$@";do
        echo "(message \"Installing $n ($package_file)...\" ) (package-install '$n)" >> "$package_file"
    done
    emacs -q --batch -l "$package_file"
}
hemacs_print_package_code() {
    cat <<EOF
(require 'package)
;; (setq gnutls-algorithm-priority "NORMAL:-VERS-TLS1.2")
(setq package-check-signature nil)
(setq
    package-archives
    '( ("melpa-stable" . "http://stable.melpa.org/packages/")
       ("gnu"          . "http://elpa.gnu.org/packages/")
       ("melpa"        . "http://melpa.org/packages/")
      ))
(package-initialize)
EOF
}






## --- [ESSENTIALS] ---------------------------------------------------------------------------------
hemacs_install_essentials() {
    hutil info "Installing basic configuration in ~/.emacs.d/init.el ..."
    hemacs_ins_code "HEMACS" <<EOF
(setq-default indent-tabs-mode nil)
(setq-default c-file-style "k&r")
(setq-default c-basic-offset 4)
(setq gnutls-algorithm-priority "NORMAL:-VERS-TLS1.2")

(require 'tool-bar)
(require 'package)

;; Disable "modified file" issue when using VirtualBox shared folders.
(global-auto-revert-mode nil)

;; Make ugly tooltips yellow and nice.
(setq x-gtk-use-system-tooltips nil)
(custom-set-faces
 '(tooltip ((t (:inherit nil :background "lightyellow" :foreground "black")))))

;; 
(setq frame-title-format '("" "Emacs [%b]"))
(setq inhibit-startup-message t)
(tool-bar-mode -1)
(setq make-backup-files nil) ; stop creating backup~ files
(setq auto-save-default nil) ; stop creating #autosave# files
(add-to-list 'custom-theme-load-path "~/.emacs.d/themes")
(set 'load-path (nconc (file-expand-wildcards "~/.emacs.d/packages/*") load-path))
(dolist (filename (file-expand-wildcards "~/.emacs.d/profile.d/*.el"))
   (print filename)
   (load-file filename))

`hemacs_print_package_code`

(defun load-auto-file (filename)
   (let ((f (locate-dominating-file default-directory filename)))
      (when f 
         (load-file (concat f filename)))))
(setq hemacs-options-loaded nil)

EOF
    
}
hemacs_install_normal() {
    hutil info "Installing flycheck ..."
    hemacs -P flycheck
    hutil info "Installing 'company' and 'company-quickhelp' ..."
    hemacs -P company
    hemacs -P company-quickhelp
    hemacs -P company-c-headers
    hutil info "Installing 'sr-speedbar' ..."
    hemacs -P sr-speedbar
    hutil info "Installing 'yafolding' ..."
    hemacs -P yafolding
    hutil info "Installing 'yasnippet' and yasnippet-snippets"
    hemacs -P "yasnippet" "yasnippet-snippets"
    hutil info "Editing ~/.emacs.d/init.el ..."
    hemacs_ins_code BASE <<EOF

;; ====[ COMPANY ]==============================================================
(require 'company)
(company-quickhelp-mode 1)
(add-hook 'after-init-hook 'global-company-mode)
;;(setq company-backends (delete 'company-semantic company-backends))
(global-set-key [(control return)] 'company-complete)
(add-to-list 'company-backends 'company-c-headers)

;; ====[ SPEEDBAR ]=============================================================
(require 'sr-speedbar)
(add-to-list 'special-display-buffer-names "*Buffer List*")
(global-set-key [f2] #'sr-speedbar-toggle)

;; ====[ YAFOLDING ]============================================================
(global-set-key [f1] #'yafolding-toggle-element)
(add-hook 'prog-mode-hook (lambda () (yafolding-mode)))

;; ====[ YASNIPPET ]============================================================
(dolist (l (file-expand-wildcards "~/.emacs.d/elpa/yasnippet-*"))
   (add-to-list 'load-path l))
(require 'yasnippet)
(add-hook 'prog-mode-hook #'(lambda () (yas-minor-mode) (yas-reload-all)))
(add-to-list 'yas-snippet-dirs "~/.yasnippet")
(define-key yas-minor-mode-map (kbd "<tab>") nil)
(define-key yas-minor-mode-map (kbd "TAB")   nil)
(define-key yas-minor-mode-map (kbd "C-c RET") 'yas-expand)
(setq yas-indent-line nil)
(add-hook 'markdown-mode-hook #'(lambda () (yas-minor-mode) (yas-reload-all)))
(add-hook 'html-mode-hook     #'(lambda () (yas-minor-mode) (yas-reload-all)))

EOF
    if test -n "${YASNIPPET}";then
	hutil info "Linking ~/.yasnippet to ${YASNIPPET} ..."
	rm -f ~/.yasnippet
	ln -s "${YASNIPPET}" ~/.yasnippet
    fi
}





##------------------------------------------------------------------------------------------
hemacs_calc_variables
if test @"`basename "$0"`" = @"hemacs";then
    if test -n "$1";then
        hemacs "$@"
    else
        hutil help
    fi
fi
